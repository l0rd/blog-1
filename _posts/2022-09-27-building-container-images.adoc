---
title: Building Container Images on OpenShift in Rootless Mode
layout: post
author: Mario Loriedo
description: >-
  In this blog post, we are going to see how to configure Eclispe Che to run `podman build` from a remote development environment.
categories: []
keywords: ['buildah', 'podman',]
slug: /@mloriedo/building-container-images
---

:source-highlighter: highlight.js

Nowdays the typical developer flow, the inner-loop, includes quite often the build of a `Dockerfile`. Despite that Eclipse Che didn't support bulding container images on OpenShift. That's because it involved granting permissive OpenShift privileges to Che users and we didn't wanted to require that.

The good new is that today there are a few options that allow building container images without compromising the underlying OpenShift cluster security. One of these is running in rootless mode and that's what we are going to discuss in this short blog post.

Although it's now easy to link:https://github.com/containers/buildah/blob/main/docs/tutorials/05-openshift-rootless-build.md[run `buildah` or `podman build` in rootless mode], on OpenShift it requires the grant of some non-default link:https://man7.org/linux/man-pages/man7/capabilities.7.html[Linux capabilities]: `CAP_SETGID` and `CAP_SETUID`. It's possible to provide those capabilities to an Eclipse Che workspace following these steps:

1. <<step_1>>
2. <<step_2>>
3. <<step_3>>
4. <<step_4>>

The first 3 steps setup the OpenShift cluster and Eclipse Che. These are administration tasks. The last step is for users that start a workspace: every workspace that requires `CAP_SETGID` and `CAP_SETUID` capability need that Devfile attribute.

== STEP 1: Creating an OpenShift Security Context Constraint [[step_1]]

In OpenShift, permissions for Pods are controlled with link:https://docs.openshift.com/container-platform/latest/authentication/managing-security-context-constraints.html[security context constraints (SCC)]. OpenShift comes with some pre-defined SCCs but the `restricted` SCC (the default one) doesn't provide enough capabilities and the `non-root` SCC provides more capabilities than required. To be able to build containers but avoid granting unrequired privileges we need to define an ad-hoc SCC that we call `container-build`. 

Use an admin account to create it on an OpenShift cluster with the following command:

[source,bash]
----
kubectl apply -f - <<EOF
apiVersion: security.openshift.io/v1
kind: SecurityContextConstraints
metadata:
  name: container-build
allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
allowPrivilegeEscalation: true
allowPrivilegedContainer: false
allowedCapabilities:
  - SETUID
  - SETGID
defaultAddCapabilities: null
fsGroup:
  type: MustRunAs
# Temporary workaround for https://github.com/devfile/devworkspace-operator/issues/884
priority: 20
readOnlyRootFilesystem: false
requiredDropCapabilities:
  - KILL
  - MKNOD
runAsUser:
  type: MustRunAsRange
seLinuxContext:
  type: MustRunAs
supplementalGroups:
  type: RunAsAny
users: []
groups: []
volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - persistentVolumeClaim
  - projected
  - secret
EOF
----

== STEP 2: Grant privileges to the DevWorkspace controller Service Account [[step_2]]

The DevWorkspace controller provisions Che workspaces Pods and is run by the Service Account `system:serviceaccount:openshift-operators:devworkspace-controller-serviceaccount`. 

The following commands are required to grant `get` and `update` on the `container-build` SCC to that SA:

[source, bash]
----
# Create the cluster role get-n-update-container-build-scc
kubectl apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: get-n-update-container-build-scc
rules:
- apiGroups:
  - "security.openshift.io"
  resources:
  - "securitycontextconstraints"
  resourceNames:
  - "container-build"
  verbs:
  - "get"
  - "update"
EOF

# Add the role to the DevWorkspace controller Service Account
oc adm policy add-cluster-role-to-user \
       get-n-update-container-build-scc \
       system:serviceaccount:openshift-operators:devworkspace-controller-serviceaccount
----

== STEP 3: Grant privileges to developers accounts [[step_3]]

To avoid a privilege escalation, when provisioing the workspace Pod, the DevWorkspace controller checks that the developer is allowed to use the `container-buld` SCC. An administrator needs to grant such privileges. Here is an example of the comamnd to add the `container-build` SCC to the user `janedoe`:

[source, bash]
----
oc adm policy add-scc-to-user container-build janedoe
----

If this step is skipped and the developer account is not allowed, Che will fail to start a workspace using the `conatiner-build` SCC.

== STEP 4: Include the `scc` attribute in Devfiles [[step_4]]

The last requirement, to build containers from an Eclispe Che workspace, is adding the attribute `controller.devfile.io/scc: container-build` in the Devfile like in this example:

[source, yaml]
----
schemaVersion: 2.1.0
metadata:
  name: build-test
attributes:
  controller.devfile.io/scc: container-build
projects:
- name: dockerfile-hello-world
  git:
    remotes:
      origin: https://github.com/l0rd/dockerfile-hello-world
components:
- name: devtooling-container
  container:
    image: quay.io/devspaces/udi-rhel8:next
    memoryLimit: 1Gi 
    cpuLimit: 1000m
----

When the Devfile has that attribue then the workspace Pod has the annotation `openshift.io/scc: container-build`:

[source, bash]
----
$ oc get pod workspace52aa1da24d244cef -o yaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    openshift.io/scc: container-build
(...)
----

And it's now possible to open a terminal and build a Dockerfile:

.Running podman build
image::/assets/img/building-container-images/podman-build.gif[Running podman build]

== What's next?

Althought that 

- Fuse instead of VFS
- `podman run`
- `docker build`
- User namespaces
- Simplify the config: CheCluster fields to allow the build